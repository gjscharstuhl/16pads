
@init

function editcontrolsinit()
local(x,y)
(
  level=gmem[padlevel+gfocus];
  x=270;y=320;gap=95;
  aknob.knobinit(0,x,y,73,59,12,11,3,5000,127);
  dknob.knobinit(0,x+gap,y,73,59,12,11,1,3000,127);
  sknob.knobinit(0,x+gap*2,y,73,59,12,11,0,1,127);
  rknob.knobinit(0,x+gap*3,y,73,59,12,11,3,5000,127);
  vknob.knobinit(0,x+gap*4,y,73,59,12,11,0,1,127);
  lx=0;rx=0;
  mousewold=0;
  gfxoffset=0;
  
);

function getsample(pad,level)
local(pad,level,str)
(
  editcontrolsinit();
  #str=(pad*16)+level;
  
  getfile(#str,0,pad);

 
  attack=gmem[env_a+(gfocus*16)+level];
  decay=gmem[env_d+(gfocus*16)+level];
  sustain=gmem[env_s+(gfocus*16)+level];
  release=gmem[env_r+(gfocus*16)+level];
  volume=gmem[sampvol+(gfocus*16)+level];
  fac=1;
  gfxoffset=0;
  clicked=0;
  mousewold=mouse_wheel;

);

function marker(x,y,w,h,bf,marker*)
local (gx,cursor)
(
  x=x*scale;y=y*scale;w=w*scale;h=h*scale;
  
  marker>0 ? (
    setcolor(yellow);
    gx=max(x,min(x+w,mouse_x));
    mouse_cap && clicked==0? 
    (

      marker=0;
      clicked=1;
      sx=(gx-x+gfxoffset)/w*bf;
      
    );    
    marker ==1 ? gmem[lp1+(gfocus*16)+level]=max(0,(gx-x-gfxoffset)/w*bf/fac);
    marker ==2 ? gmem[lp2+(gfocus*16)+level]=(gx-x-gfxoffset)/w*bf/fac;
 
  );
 

);


function editdebug()
(

  debug(500,20,200,440,10,20);
  print("level %f",gmem[padlevel+gfocus]);
  print("attack %f",gmem[env_a+(gfocus*16)+level]);
  print("clicked %d",clicked);
  setcolor(red);
  print("gx= %d",gx);
  print("bf= %f",bf);
  print("w= %d",w);
  print("sx= %f",sx);
  
  print ("lp1 %f",gmem[lp1+(gfocus*16)+level]);
  print ("lp2 %f",gmem[lp2+(gfocus*16)+level]);
  print ("loop %d",gmem[sloop+(gfocus*16)+level]);
);


function editscreen()
local(x,y,fs)
(
  gfx_x=0;gfx_y=0;
  gfx_getimgdim(5, imgw, imgh) ;
  gfx_blit(5,scale, 0);
  
  fs=15;
  level=gmem[padlevel+gfocus];
  gfxprint(aknob.x+30,aknob.y-20,"A",fs);
  aknob.knob(attack);
  aknob.knobdrag(attack,0);
  gfxprint(dknob.x+30,dknob.y-20,"D",fs);
  dknob.knob(decay);
  dknob.knobdrag(decay,0);
  gfxprint(sknob.x+30,sknob.y-20,"S",fs);
  sknob.knob(sustain);
  sknob.knobdrag(sustain,0);
  gfxprint(rknob.x+30,rknob.y-20,"R",fs);
  rknob.knob(release);
  rknob.knobdrag(release,0);
  gfxprint(vknob.x+30,vknob.y-20,"V",fs);
  vknob.knob(volume);
  vknob.knobdrag(volume,0);
  
  gmem[env_a+(gfocus*16)+level]=attack;
  gmem[env_d+(gfocus*16)+level]=decay;
  gmem[env_s+(gfocus*16)+level]=sustain;
  gmem[env_r+(gfocus*16)+level]=release;
  gmem[sampvol+(gfocus*16)+level]=volume;;
  gmem[p2+(gfocus*16)+level]<1 ? gmem[p2+(gfocus*16)+level]=bufsize;

  
  
  x=280;y=75;w=415;h=190;bf=bufsize;
  //? mouse_wheel>0 ? (fac/2*;mouse_wheel=0;)
  
  
  //mouse_cap&8==1 && mouse_wheel >mousew2old ? (gfxoffset+=30;mousew2old=mouse_wheel);
  //mouse_cap&8==1 && mouse_wheel <mousew2old ? (gfxoffset-=30;mousew2old=mouse_wheel);
  
  drawwav(x,y,w,h,bufstart,bf);
  marker(x,y,w,h,bf,setleftmarker);
  marker(x,y,w,h,bf,setrightmarker);
  
  mouse_wheel >mousewold ? (
    mouse_cap&8 ? (
        fac=fac*1.2;
        gfxoffset*=1.2;
        
      ):(
        gfxoffset+=(30*scale);

      );
    mousewold=mouse_wheel;
  );
  mouse_wheel <mousewold ? (
    mouse_cap&8 ? (
      fac=fac/1.2;
      gfxoffset/=1.2;
    ):
    (
      gfxoffset-=(30*scale);
    );
    mousewold=mouse_wheel;
  );
  
  mouse_cap==0 && zoom ? (gfxoffset=gfxoffsetold;zoom=0;);
  setleftmarker ? blmcol=1:blmcol=0;
  setrightmarker ? brmcol=1:brmcol=0;
  
  y=410;x=370;
  //imgindex(6,x,450,60,40,1,2,1);
  blm.imgbutton(6,1,2,blm,x,y,70,25,1,blmcol,1,0,"leftmarker",10,0);
  blm.event ? (setleftmarker=1;blm.event=0);
  brm.imgbutton(6,1,2,brm,x+100,y,70,25,1,brmcol,1,0,"rightmarker",10,0);
  brm.event ? (setrightmarker=2;brm.event=0);
  gmem[sloop+(gfocus*16)+level] ? lpbcol=1 : lpbcol=0 ;
  lp.imgbutton(6,1,2,lp,x+200,y,70,25,lpbcol,lpbcol,1,0,"loop on",10,0);
  lp.event && clicked==0 && lp.focus && mouse_cap==1 ? (gmem[sloop+(gfocus*16)+level]=!gmem[sloop+(gfocus*16)+level];lp.event=0;clicked=1;);

  mouse_cap==0 ? clicked=0;
  
  x=460;
  y=460;
  bw=140;
  bh=50;
  returnbut=buttons+5;
  returnbut.imgbutton(3,2,2,returnbut,x,y,100,25,1,0,1,white,"Return",fs,0);
  returnbut.event && clicked==0 ? (editwav=0;returnbut.event=0;);
  //editdebug();
);



